<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Climate Label Experiment</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: white;
      margin-top: 40px;
    }
    #stimulus {
      width: 200px;
      height: 300px;
      margin: 20px auto;
    }
    .btn {
      padding: 10px 20px;
      margin: 5px;
      font-size: 18px;
      cursor: pointer;
    }
    .selected {
      background-color: green;
      color: white;
    }
    .input-box {
      font-size: 24px;
      padding: 5px;
      width: 100px;
    }
    #next {
      background: gray;
      pointer-events: none;
    }
  </style>
</head>
<body>

<!-- Start Screen -->
<div id="start-screen">
  <h2>Velkommen</h2>
  <p>Indtast deltager ID:</p>
  <input type="text" id="participant-id" required>
  <br><br>
  <button onclick="loadStimuli()">Start</button>
</div>

<!-- Trial Area -->
<div id="trial-area" style="display:none">
  <h2>Climate Label Experiment</h2>
  <img id="stimulus" src="" alt="stimulus">
  <div>
    <label>Enter Price:</label>
    <input type="number" id="price" class="input-box" maxlength="5">
  </div>
  <p>Click to select the climate label:</p>
  <div id="labels"></div>
  <button id="next" class="btn">Next</button>
</div>

<!-- Debrief -->
<div id="debrief-screen" style="display:none"></div>

<script>
let trials = [];
let current = 0;
let startTime = null;
let selectedLabel = null;
let trialDataLog = [];
const labelOptions = ['A', 'B', 'C', 'D', 'E'];

// Load CSV and start experiment
async function loadStimuli() {
  const response = await fetch('stimuli.csv'); // Or 'data/stimuli.csv' if it's in a folder
  const text = await response.text();
  const rows = text.trim().split('\n').slice(1); // Skip header
  trials = rows.map(row => {
    const [itemID, labelPosition, labelType, imageFile] = row.split(',');
    return { itemID, labelPosition, labelType, imageFile };
  });

  // Shuffle
  trials = trials.sort(() => 0.5 - Math.random());

  document.getElementById("start-screen").style.display = "none";
  document.getElementById("trial-area").style.display = "block";
  showTrial();
}

function showTrial() {
  const trial = trials[current];
  document.getElementById("stimulus").src = `images/${trial.imageFile}`;
  document.getElementById("price").value = "";
  document.getElementById("next").style.background = "gray";
  document.getElementById("next").style.pointerEvents = "none";
  selectedLabel = null;

  // Label buttons
  const labelDiv = document.getElementById("labels");
  labelDiv.innerHTML = "";
  labelOptions.forEach(label => {
    const btn = document.createElement("button");
    btn.innerText = label;
    btn.className = "btn";
    btn.onclick = () => {
      selectedLabel = label;
      document.querySelectorAll("#labels .btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      checkEnableNext();
    };
    labelDiv.appendChild(btn);
  });

  startTime = performance.now();
}

function checkEnableNext() {
  const price = document.getElementById("price").value;
  if (price && selectedLabel) {
    const nextBtn = document.getElementById("next");
    nextBtn.style.background = "blue";
    nextBtn.style.pointerEvents = "auto";
  }
}

document.getElementById("price").addEventListener("input", checkEnableNext);

document.getElementById("next").onclick = () => {
  const endTime = performance.now();
  const rt = ((endTime - startTime) / 1000).toFixed(2);
  const trial = trials[current];
  trialDataLog.push({
    participant: document.getElementById("participant-id").value,
    itemID: trial.itemID,
    labelPosition: trial.labelPosition,
    labelType: trial.labelType,
    priceResponse: document.getElementById("price").value,
    labelResponse: selectedLabel,
    reactionTime: rt
  });

  current++;
  if (current < trials.length) {
    showTrial();
  } else {
    finishExperiment();
  }
};

async function sendToOSF() {
  if (!trialDataLog.length) return;

  const headers = Object.keys(trialDataLog[0]);
  const rows = trialDataLog.map(row =>
    headers.map(h => `"${row[h]}"`).join(',')
  );
  const csvContent = [headers.join(','), ...rows].join('\n');

  const participantId = document.getElementById("participant-id").value;
  const dateStr = new Date().toISOString().split("T")[0];
  const filename = `${participantId}_${dateStr}.csv`;

  const debrief = document.getElementById("debrief-screen");
  debrief.innerHTML = `
    <h2>Gemmer dine data...</h2>
    <p>Vent venligst - luk ikke fanen endnu.</p>
  `;
  debrief.style.display = "block";

  const maxRetries = 3;
  let success = false;

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const res = await fetch("https://osf-uploader.onrender.com/upload", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename, content: csvContent })
      });

      if (!res.ok) throw new Error("Upload failed");

      debrief.innerHTML = `
        <h2>Tak for din deltagelse!</h2>
        <p>Dine data er nu gemt.</p>
        <p>Du må gerne lukke fanen.</p>
      `;
      success = true;
      break;
    } catch (err) {
      console.warn(`⏳ Upload forsøg #${attempt} mislykkedes`, err);
      if (attempt < maxRetries) await new Promise(res => setTimeout(res, 5000));
    }
  }

  if (!success) {
    debrief.innerHTML = `
      <h2>Fejl</h2>
      <p>Data kunne ikke gemmes efter gentagne forsøg.<br>
      Kontakt forsøgslederen.</p>
    `;
  }
}

function finishExperiment() {
  document.getElementById("trial-area").style.display = "none";
  sendToOSF();
}
</script>

</body>
</html>
